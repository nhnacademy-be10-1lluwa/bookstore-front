<!DOCTYPE html>
<html layout:decorate="~{layout/layout}"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head layout:fragment="head">
    <link rel="stylesheet" th:href="@{/css/main.css}"/>
    <link rel="stylesheet" th:href="@{/css/page/_address-list.css}"/>
    <link rel="stylesheet" th:href="@{/css/component/_pagination.css}"/>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            z-index: 999;
        }

        .modal-content {
            background: #fff;
            margin: 5% auto;
            padding: 20px;
            max-width: 800px;
            position: relative;
            border-radius: 4px;
            overflow-y: auto;
            max-height: 80vh;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
        }

        .select-address {
            margin-top: 8px;
        }
    </style>
</head>

<main layout:fragment="content">

    <h2>ì£¼ë¬¸ ì •ë³´ ì…ë ¥</h2>

    <!-- ì£¼ë¬¸ ì…ë ¥ í¼ -->
    <form th:action="@{/member/orders/confirm}" method="post" th:object="${orderRequest}" class="order-form">


        <!-- 1. ì£¼ë¬¸ ìƒí’ˆ ìš”ì•½ -->
        <section class="item-summary">
            <h3>ì£¼ë¬¸ ìƒí’ˆ</h3>
            <p>
                <strong th:text="${init.item.title}">ë„ì„œ ì œëª©</strong>
                &nbsp;|&nbsp;
                <span th:text="${#numbers.formatDecimal(init.item.getRegularPrice(), 0, 'COMMA', 0, 'DEFAULT')}">0</span>ì›
                <span th:text="${#numbers.formatDecimal(init.item.getSalePrice(), 0, 'COMMA', 0, 'DEFAULT')}">0</span>ì›
            </p>
            <input type="hidden" name="bookId" th:value="${init.item.bookId}"/>
            <input type="hidden" id="unitPrice"
                   th:value="${init.item.getSalePrice() != null ? init.item.getSalePrice() : init.item.getRegularPrice()}" />

            <label class="quantity-label" style="display:inline-block;margin-left:12px;">
                ìˆ˜ëŸ‰ :
                <input type="number" id="quantityInput" name="quantity" min="1" value="1"
                       style="width:60px;" />
            </label>
        </section>

        <!-- 2. ë°°ì†¡ì§€ ì„ íƒ -->
        <section class="address-select">
            <h3>ë°°ì†¡ì§€ ì„ íƒ</h3>

            <!-- í˜„ì¬ ì„ íƒëœ ì£¼ì†Œ(í˜ì´ì§€ ìµœì´ˆì—ëŠ” ê¸°ë³¸ ì£¼ì†Œ í‘œì‹œ) -->
            <div id="selectedAddressArea">
                <div th:each="addr, iterStat : ${init.recipients}">
                    <input type="radio"
                           th:id="'addr' + ${iterStat.index}"
                           name="memberAddressId"
                           th:value="${addr.memberAddressId}"
                           th:checked="${addr.getForcedDefaultAddress()}"/>
                    <label th:for="'addr' + ${iterStat.index}">
                        <span th:text="${addr.addressName}">ìš°ë¦¬ì§‘</span> :
                        <span th:text="${addr.address + ' ' + addr.detailAddress}">ì„œìš¸íŠ¹ë³„ì‹œ â€¦</span>
                        (<span th:text="${addr.recipientName}">í™ê¸¸ë™</span>,
                        <span th:text="${addr.recipientContact}">01012345678</span>)
                    </label>
                </div>
            </div>
            <div>
                <label>ìš°í¸ë²ˆí˜¸</label>
                <input type="text" id="postcode" name="postCode"
                       th:value="${address?.postCode}" />
                <button type="button" id="postcodeBtn" onclick="openPostcode()">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>

                <label>ì£¼ì†Œ</label>
                <input type="text" id="address" name="address"
                       th:value="${address?.address}" />

                <label>ìƒì„¸ì£¼ì†Œ</label>
                <input type="text" id="detailAddress" name="detailAddress"
                       th:value="${address?.detailAddress}"
                       placeholder="ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" />

                <label>ì£¼ì†Œ ë³„ì¹­</label>
                <input type="text" id="addressName" name="addressName"
                       th:value="${address?.addressName}"
                       placeholder="ì˜ˆ: ì§‘, íšŒì‚¬" />

                <label>ë°›ëŠ” ì‚¬ëŒ</label>
                <input type="text" id="recipientName" name="recipientName"
                       th:value="${address?.recipientName}"
                       placeholder="ë°›ëŠ” ë¶„ ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" />

                <label>ì—°ë½ì²˜</label>
                <input type="tel" id="recipientContact" name="recipientContact"
                       th:value="${address?.recipientContact}"
                       placeholder="010-0000-0000" />

                <label class="checkbox-label">
                    <input type="checkbox" id="isDefaultCheckbox"
                           th:checked="${address?.defaultAddress}" />
                    <!-- ì‹¤ì œ ì „ì†¡ë  ê°’ -->
                    <input type="hidden" name="defaultAddress" id="defaultAddressInput" value="false" />
                    ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì„¤ì •
                </label>
            </div>


            <button type="button" id="openAddressModal" class="btn">ë‚´ ì£¼ì†Œ</button>
        </section>

        <!-- 3. ì¿ í° ì ìš© -->
        <section class="coupon-select">
            <h3>ì¿ í° ì„ íƒ</h3>
            <select name="memberCouponId">
                <option value="">ì¿ í° ì„ íƒ (ì„ íƒ ì‚¬í•­)</option>
                <option th:each="coupon : ${init.availableCoupons}"
                        th:value="${coupon.memberCouponId}"
                        th:attr="data-rate=${coupon.discountRate ?: ''},data-amount=${coupon.discountAmount ?: ''}"
                        th:text="${coupon.couponName + ' (' + coupon.couponCode + ')'}">
                </option>
            </select>
        </section>

        <!-- 4. í¬ì¥ ì˜µì…˜ -->
        <section class="packaging-select">
            <h3>í¬ì¥ ì˜µì…˜</h3>
            <div th:each="pkg, iterStat : ${init.packaging}">
                <label>
                    <input type="radio"
                           th:id="'pkg' + ${iterStat.index}"
                           name="packagingId"
                           th:value="${pkg.packagingId}"
                    th:attr="data-price=${pkg.packagingPrice}"/>
                </label>
                <label th:for="'pkg' + ${iterStat.index}"
                       th:text="${pkg.packagingName + ' (' + #numbers.formatDecimal(pkg.packagingPrice, 0, 'COMMA', 0, 'DEFAULT') + 'ì›)'}">
                    ê¸°ë³¸ í¬ì¥
                </label>
            </div>
            <input type="radio" id="noPkg" name="packagingId" value="" data-price="0" checked/>
            <label for="noPkg">í¬ì¥ ì—†ìŒ</label>
        </section>

        <!-- 5. í¬ì¸íŠ¸ ì‚¬ìš© -->
        <section class="point-use">
            <h3>í¬ì¸íŠ¸ ì‚¬ìš©</h3>
            <p>
                ë³´ìœ  í¬ì¸íŠ¸ :
                <strong th:text="${(init.pointBalance)}">0</strong> P
            </p>
            <label>
                <input type="number"
                       name="usedPoint"
                       min="0"
                       step="100"
                       th:max="${init.pointBalance}"
                       placeholder="ì‚¬ìš©í•  í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"/>
            </label>
        </section>

        <!-- 7. ì£¼ë¬¸ í•©ê³„ / ì œì¶œ -->
        <section class="submit-area">
            <p>
                ì˜ˆìƒ ê²°ì œ ê¸ˆì•¡ :
                <span id="estimatedTotal"> <!-- JSì—ì„œ ì‹¤ì‹œê°„ ê³„ì‚°í•˜ë©´ ì´ê³³ì„ ê°±ì‹  -->
                    <!-- ì„œë²„ ê³„ì‚° ê²°ê³¼ê°€ ìˆë‹¤ë©´ ì•„ë˜ì²˜ëŸ¼ í‘œì‹œ ê°€ëŠ¥
                    <span th:text="${#numbers.formatDecimal(init.item.price + (init.packaging.?[defaultPackage].packagingPrice ?: 0), 0, 'COMMA', 0, 'DEFAULT')}">0</span>ì› -->
                </span>
            </p>
            <button type="submit">ì£¼ë¬¸ í™•ì •</button>
        </section>
    </form>

    <script>
        // ë‹¤ìŒ ìš°í¸ë²ˆí˜¸ api
        function openPostcode() {
            new daum.Postcode({
                oncomplete: function(data) {
                    // ë„ë¡œëª… ì£¼ì†Œë§Œ í—ˆìš©
                    if (data.userSelectedType !== 'R') {
                        alert("ë„ë¡œëª… ì£¼ì†Œë¡œ ì„ íƒí•´ì£¼ì„¸ìš”! ğŸ›£ï¸");
                        return;
                    }

                    let roadAddr = data.roadAddress;
                    let extraAddr = '';

                    if(data.bname && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)){
                        extraAddr += data.bname;
                    }
                    if(data.buildingName){
                        extraAddr += (extraAddr ? ', ' + data.buildingName : data.buildingName);
                    }

                    let fullAddr = extraAddr ? `${roadAddr} (${extraAddr})` : roadAddr;

                    document.getElementById('postcode').value = data.zonecode;
                    document.getElementById('address').value = fullAddr;
                    document.getElementById('detailAddress').focus();
                }
            }).open();
        }

        const form = document.querySelector('.form-card');

        form.addEventListener('submit', function(event) {
            const postCode = form.querySelector('input[name="postCode"]').value.trim();
            const address = form.querySelector('input[name="address"]').value.trim();
            const detailAddress = form.querySelector('input[name="detailAddress"]').value.trim();
            const recipientName = form.querySelector('input[name="recipientName"]').value.trim();
            const recipientContact = form.querySelector('input[name="recipientContact"]').value.trim();

            const isDefaultChecked = document.getElementById("isDefaultCheckbox").checked;
            document.getElementById("defaultAddressInput").value = isDefaultChecked ? "true" : "false";

            // ì£¼ì†Œ ê°œìˆ˜ ì œí•œ ê²€ì‚¬
            const mode = form.dataset.mode;
            if (mode === 'new' && typeof addressCount !== 'undefined' && addressCount >= 10) {
                alert("ì£¼ì†ŒëŠ” ìµœëŒ€ 10ê°œê¹Œì§€ ë“±ë¡í•  ìˆ˜ ìˆì–´ìš”! ğŸ˜…");
                event.preventDefault();
                return;
            }

            // í•„ìˆ˜ ì…ë ¥ ê²€ì¦
            if (!postCode || !address || !detailAddress || !recipientName || !recipientContact) {
                alert("í•„ìˆ˜ ì…ë ¥ë€ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”! ğŸ™");
                event.preventDefault(); // í¼ ì œì¶œ ë§‰ê¸°
            }
        });
    </script>

    <!-- ì„œë²„ì—ì„œ ì£¼ì…í•œ ê°’ë§Œ ë‹´ëŠ” ì‘ì€ ìŠ¤í¬ë¦½íŠ¸ -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        window.orderMemberInit = {
            addressCount: /*[[${addressCount}]]*/ 0
        };
        /*]]>*/
    </script>
    <!-- ì‹¤ì œ ë™ì‘ ë¡œì§ -->
    <script th:src="@{/js/order/order_member_form.js}" defer></script>
</main>

<!-- ì£¼ì†Œë¡ ëª¨ë‹¬ -->
<div id="addressModal" class="modal" th:fragment="addressModal">
    <div class="modal-content">
        <span id="closeAddressModal" class="modal-close">&times;</span>

        <div class="header-row">
            <h2 class="title">ğŸ“š ë‚˜ì˜ ì£¼ì†Œë¡</h2>
            <a href="javascript:void(0);" id="newAddressBtn" class="btn add-address">+ ìƒˆ ì£¼ì†Œ ë“±ë¡</a>
        </div>

        <div class="address-list">
            <div th:if="${#lists.isEmpty(init.getRecipients())}" class="empty-message">
                <p>ë“±ë¡ëœ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ì£¼ì†Œë¥¼ ë“±ë¡í•´ì£¼ì„¸ìš”! ğŸ“­</p>
            </div>

            <div class="address-card"
                 th:each="address, stat : ${init.getRecipients()}"
                 th:data-id="${address.memberAddressId}">
                <div class="address-info">
                    <div class="name">
                        <i class="fas fa-user"></i>
                        <span th:text="${address.recipientName}">í™ê¸¸ë™</span>
                        <span class="badge" th:if="${address.getForcedDefaultAddress()}">ê¸°ë³¸</span>
                    </div>
                    <div class="contact">
                        <i class="fas fa-phone"></i>
                        <span th:text="${address.recipientContact}">010-1234-5678</span>
                    </div>
                    <div class="address">
                        <i class="fas fa-home"></i>
                        <span th:text="${address.address + ' ' + address.detailAddress}">ì„œìš¸ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 101í˜¸</span>
                    </div>
                    <div class="alias">
                        <i class="fas fa-tag"></i>
                        <span th:text="${address.addressName}">íšŒì‚¬</span>
                    </div>
                </div>
                <button type="button" class="btn select-address">ì„ íƒ</button>
            </div>
        </div>

        <!--&lt;!&ndash; í˜ì´ì§€ë„¤ì´ì…˜ &ndash;&gt;
        <div class="pagination">
            <button th:if="${currentPage > 0}"
                    th:onclick="'location.href=\'/address-list?page=' + (${currentPage} - 1) + '\''">
                â—€ ì´ì „
            </button>

            <span th:each="i : ${#numbers.sequence(0, lastPageIndex)}">
                <a th:href="@{'/address-list?page=' + ${i}}"
                   th:text="${i + 1}"
                   th:classappend="${i == currentPage} ? 'active-page' : ''">1</a>
            </span>

            <button th:if="${currentPage < (totalPages > 0 ? totalPages - 1 : 0)}"
                    th:onclick="'location.href=\'/address-list?page=' + (${currentPage} + 1) + '\''">
                ë‹¤ìŒ â–¶
            </button>
        </div>-->
    </div>
</div>
</html>