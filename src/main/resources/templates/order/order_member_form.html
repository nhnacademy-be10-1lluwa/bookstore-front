<!DOCTYPE html>
<html layout:decorate="~{layout/layout}"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head layout:fragment="head">
    <link rel="stylesheet" th:href="@{/css/main.css}"/>
    <link rel="stylesheet" th:href="@{/css/page/_address-list.css}"/>
    <link rel="stylesheet" th:href="@{/css/component/_pagination.css}"/>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            z-index: 999;
        }

        .modal-content {
            background: #fff;
            margin: 5% auto;
            padding: 20px;
            max-width: 800px;
            position: relative;
            border-radius: 4px;
            overflow-y: auto;
            max-height: 80vh;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
        }

        .select-address {
            margin-top: 8px;
        }
    </style>
</head>

<main layout:fragment="content">

    <h2>μ£Όλ¬Έ μ •λ³΄ μ…λ ¥</h2>

    <!-- μ£Όλ¬Έ μ…λ ¥ νΌ -->
    <form th:action="@{/order/order-form/submit-direct}" method="post" th:object="${orderRequest}" class="order-form">


        <!-- 1. μ£Όλ¬Έ μƒν’ μ”μ•½ -->
        <section class="item-summary">
            <h3>μ£Όλ¬Έ μƒν’</h3>
            <p>
                <strong th:text="${init.item.title}">λ„μ„ μ λ©</strong>
                &nbsp;|&nbsp;
                <span th:text="${#numbers.formatDecimal(init.item.getRegularPrice(), 0, 'COMMA', 0, 'DEFAULT')}">0</span>μ›
                <span th:text="${#numbers.formatDecimal(init.item.getSalePrice(), 0, 'COMMA', 0, 'DEFAULT')}">0</span>μ›
            </p>
            <input type="hidden" th:field="*{item.bookId}" th:value="${init.item.bookId}"/>
            <input type="hidden" id="unitPrice"
                   th:value="${init.item.getSalePrice() != null ? init.item.getSalePrice() : init.item.getRegularPrice()}"/>

            <label class="quantity-label" style="display:inline-block;margin-left:12px;">
                μλ‰ :
                <input type="number"
                       id="quantityInput"
                       th:field="*{item.quantity}"
                       min="1"
                       th:value="${initialQuantity}"
                       value="1"
                       style="width:60px;"/>
            </label>
        </section>

        <!-- 2. λ°°μ†΅μ§€ μ„ νƒ -->
        <section class="address-select">
            <h3>λ°°μ†΅μ§€ μ„ νƒ</h3>

            <div id="selectedAddressArea" style="margin-top: 10px;"></div>

            <div>
                <label>μ°νΈλ²νΈ</label>
                <input type="text" id="postcode" th:field="*{postCode}"
                       th:value="${address?.postCode}"/>
                <button type="button" id="postcodeBtn" onclick="openPostcode()">μ°νΈλ²νΈ μ°ΎκΈ°</button>

                <label>μ£Όμ†</label>
                <input type="text" id="address" th:field="*{readAddress}"
                       th:value="${address?.address}"/>

                <label>μƒμ„Έμ£Όμ†</label>
                <input type="text" id="detailAddress" th:field="*{detailAddress}"
                       th:value="${address?.detailAddress}"
                       placeholder="μƒμ„Έμ£Όμ†λ¥Ό μ…λ ¥ν•μ„Έμ”"/>

                <label>λ°›λ” μ‚¬λ</label>
                <input type="text" id="recipientName" th:field="*{recipientName}"
                       th:value="${address?.recipientName}"
                       placeholder="λ°›λ” λ¶„ μ„±ν•¨μ„ μ…λ ¥ν•΄μ£Όμ„Έμ”"/>

                <label>μ—°λ½μ²</label>
                <input type="tel" id="recipientContact" th:field="*{recipientContact}"
                       th:value="${address?.recipientContact}"
                       placeholder="010-0000-0000"/>

                <label for="deliveryDate">λ°°μ†΅ λ‚ μ§</label>
                <input type="date"
                       id="deliveryDate"
                       th:field="*{deliveryDate}"
                       th:attr="min=${#temporals.format(#temporals.createNow().plusDays(1),'yyyy-MM-dd')}"
                       th:value="${#temporals.format(#temporals.createNow().plusDays(1),'yyyy-MM-dd')}" />
                <small class="text-muted">* λ―Έμ„ νƒ μ‹ μλ™μΌλ΅ λ‚΄μΌ λ‚ μ§κ°€ μ„¤μ •λ©λ‹λ‹¤.</small>

            </div>


            <button type="button" id="openAddressModal" class="btn">λ‚΄ μ£Όμ†</button>
        </section>

        <!-- 3. μΏ ν° μ μ© -->
        <section class="coupon-select">
            <h3>μΏ ν° μ„ νƒ</h3>
            <select th:field="*{memberCouponId}">
                <option value="">μΏ ν° μ„ νƒ (μ„ νƒ μ‚¬ν•­)</option>
                <!--<option th:each="coupon : ${init.availableCoupons}"
                        th:value="${coupon.memberCouponId}"
                        th:attr="data-rate=${coupon.discountRate ?: ''},data-amount=${coupon.discountAmount ?: ''}"
                        th:text="${coupon.couponName + ' (' + coupon.couponCode + ')'}">
                </option>-->
            </select>
        </section>

        <!-- 4. ν¬μ¥ μµμ… -->
        <section class="packaging-select">
            <h3>ν¬μ¥ μµμ…</h3>
            <select id="packagingSelect" class="form-select"
                    th:field="*{item.packagingId}">
                <option th:each="pkg : ${init.packaging}"
                        th:value="${pkg.packagingId}"
                        th:attr="data-price=${pkg.packagingPrice}"
                        th:selected="${pkg.packagingId == 1}"
                        th:text="${pkg.packagingName + ' (' + #numbers.formatDecimal(pkg.packagingPrice, 0, 'COMMA', 0, 'DEFAULT') + 'μ›)'}">
                </option>
            </select>
        </section>

        <!-- 5. ν¬μΈνΈ μ‚¬μ© -->
        <section class="point-use">
            <h3>ν¬μΈνΈ μ‚¬μ©</h3>
            <p>
                λ³΄μ  ν¬μΈνΈ :
                <strong th:text="${(init.pointBalance)}"
                        th:attr="data-balance=${init.pointBalance}">0</strong> P
            </p>
            <label>
                <input type="number"
                       th:field="*{usedPoint}"
                       value="0"
                       min="0"
                       step="100"
                       th:placeholder="0"
                       th:max="${init.pointBalance}"
                       placeholder="μ‚¬μ©ν•  ν¬μΈνΈλ¥Ό μ…λ ¥ν•μ„Έμ”"/>
            </label>
            <button type="button" id="applyPointBtn">ν¬μΈνΈ μ μ©</button>
        </section>

        <!-- 7. μ£Όλ¬Έ ν•©κ³„ / μ μ¶ -->
        <section class="submit-area">
            <p>
                μμƒ κ²°μ  κΈμ•΅ :
                <span id="estimatedTotal"> <!-- JSμ—μ„ μ‹¤μ‹κ°„ κ³„μ‚°ν•λ©΄ μ΄κ³³μ„ κ°±μ‹  -->
                    </span>
            </p>
            <button type="submit">μ£Όλ¬Έ ν™•μ •</button>
        </section>
    </form>

    <!-- μ£Όμ†λ΅ λ¨λ‹¬ -->
    <div id="addressModal" class="modal" th:fragment="addressModal">
        <div class="modal-content">
            <span id="closeAddressModal" class="modal-close">&times;</span>

            <div class="header-row">
                <h2 class="title">π“ λ‚μ μ£Όμ†λ΅</h2>
                <a href="javascript:void(0);" id="newAddressBtn" class="btn add-address">+ μƒ μ£Όμ† λ“±λ΅</a>
            </div>

            <div class="address-list">
                <div th:if="${#lists.isEmpty(init.getRecipients())}" class="empty-message">
                    <p>λ“±λ΅λ μ£Όμ†κ°€ μ—†μµλ‹λ‹¤. μƒλ΅μ΄ μ£Όμ†λ¥Ό λ“±λ΅ν•΄μ£Όμ„Έμ”! π“­</p>
                </div>

                <div class="address-card"
                     th:each="address, stat : ${init.getRecipients()}"
                     th:data-id="${address.memberAddressId}"
                     th:data-postcode="${address.postCode}"
                     th:data-address="${address.address}"
                     th:data-detail-address="${address.detailAddress}"
                     th:data-address-name="${address.addressName}"
                     th:data-recipient-name="${address.recipientName}"
                     th:data-recipient-contact="${address.recipientContact}">
                    <div class="address-info">
                        <div class="name">
                            <i class="fas fa-user"></i>
                            <span th:text="${address.recipientName}">ν™κΈΈλ™</span>
                            <span class="badge" th:if="${address.getForcedDefaultAddress()}">κΈ°λ³Έ</span>
                        </div>
                        <div class="contact">
                            <i class="fas fa-phone"></i>
                            <span th:text="${address.recipientContact}">010-1234-5678</span>
                        </div>
                        <div class="address">
                            <i class="fas fa-home"></i>
                            <span th:text="${address.address + ' ' + address.detailAddress}">μ„μΈ κ°•λ‚¨κµ¬ μ—­μ‚Όλ™ 101νΈ</span>
                        </div>
                        <div class="alias">
                            <i class="fas fa-tag"></i>
                            <span th:text="${address.addressName}">νμ‚¬</span>
                        </div>

                    </div>
                    <button type="button" class="btn select-address">μ„ νƒ</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Hidden input for selected address memberAddressId (if needed by JS or for submit) -->
    <!--
    <input type="hidden" th:field="*{recipients.memberAddressId}" value="${id}">
    -->
    <!-- μ„λ²„μ—μ„ μ£Όμ…ν• κ°’λ§ λ‹΄λ” μ‘μ€ μ¤ν¬λ¦½νΈ -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        window.orderMemberInit = {
            addressCount: /*[[${addressCount}]]*/ 0
        };
        /*]]>*/
    </script>
    <!-- μ‹¤μ  λ™μ‘ λ΅μ§ -->
    <script th:src="@{/js/order/order_member_form.js}" defer></script>
</main>
</html>