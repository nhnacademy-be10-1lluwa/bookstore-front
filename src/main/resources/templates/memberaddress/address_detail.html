<!DOCTYPE html>
<html layout:decorate="~{layout/layout}"
      th:lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head layout:fragment="head" title="ì£¼ì†Œìƒì„¸">
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/page/_address-list.css}" />
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<main layout:fragment="content">
    <section class="main-content" style="position: relative;"
             th:with="actionUrl=${mode == 'edit'} ? '/addresses/save?mode=edit&addressId=' + ${address.memberAddressId} : '/addresses/save?mode=new'">

        <form th:action="@{${actionUrl}}"
              method="post"
              class="form-card"
              th:data-mode="${mode}">

            <h1>ğŸ“ ë°°ì†¡ì§€ ìƒì„¸</h1>

            <input type="hidden" name="addressId" th:if="${mode == 'edit'}" th:value="${address.memberAddressId}" />

            <label>ìš°í¸ë²ˆí˜¸</label>
            <input type="text" id="postcode" name="postCode"
                   th:readonly="${!(mode == 'new' or mode == 'edit')}"
                   th:value="${address?.postCode}" />
            <button type="button" id="postcodeBtn" th:if="${mode == 'new' or mode == 'edit'}" onclick="openPostcode()">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>

            <label>ì£¼ì†Œ</label>
            <input type="text" id="address" name="address"
                   th:readonly="${!(mode == 'new' or mode == 'edit')}"
                   th:value="${address?.address}" />

            <label>ìƒì„¸ì£¼ì†Œ</label>
            <input type="text" id="detailAddress" name="detailAddress"
                   th:readonly="${!(mode == 'new' or mode == 'edit')}"
                   th:value="${address?.detailAddress}"
                   placeholder="ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" />

            <label>ì£¼ì†Œ ë³„ì¹­</label>
            <input type="text" id="addressName" name="addressName"
                   th:readonly="${!(mode == 'new' or mode == 'edit')}"
                   th:value="${address?.addressName}"
                   placeholder="ì˜ˆ: ì§‘, íšŒì‚¬" />

            <label>ë°›ëŠ” ì‚¬ëŒ</label>
            <input type="text" id="recipientName" name="recipientName"
                   th:readonly="${!(mode == 'new' or mode == 'edit')}"
                   th:value="${address?.recipientName}"
                   placeholder="ë°›ëŠ” ë¶„ ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" />

            <label>ì—°ë½ì²˜</label>
            <input type="tel" id="recipientContact" name="recipientContact"
                   th:readonly="${!(mode == 'new' or mode == 'edit')}"
                   th:value="${address?.recipientContact}"
                   placeholder="010-0000-0000" />

            <label class="checkbox-label" th:if="${mode == 'new' or mode == 'edit'}">
                <input type="checkbox" id="isDefaultCheckbox"
                       th:checked="${address?.defaultAddress}" />
                <!-- ì‹¤ì œ ì „ì†¡ë  ê°’ -->
                <input type="hidden" name="defaultAddress" id="defaultAddressInput" value="false" />
                ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì„¤ì •
            </label>

            <div th:if="${mode == 'new' or mode == 'edit'}">
                <button type="submit" id="saveBtn">ì €ì¥</button>
            </div>

            <div th:if="${mode == 'view'}" style="margin-top: 30px; text-align:center;">
                <button type="button"
                        th:onclick="|location.href='/addresses/edit/' + ${address.memberAddressId}|">
                    ìˆ˜ì •í•˜ê¸° âœï¸
                </button>
            </div>
        </form>

        <!-- ì£¼ì†Œ ê°œìˆ˜ ìë°”ìŠ¤í¬ë¦½íŠ¸ë¡œ ë‚´ë ¤ì£¼ê¸° -->
        <script th:inline="javascript">
            let addressCount = /*[[${addressCount}]]*/ 0;
        </script>

        <script>
            // ë‹¤ìŒ ìš°í¸ë²ˆí˜¸ api
            function openPostcode() {
                new daum.Postcode({
                    oncomplete: function(data) {
                        // ë„ë¡œëª… ì£¼ì†Œë§Œ í—ˆìš©
                        if (data.userSelectedType !== 'R') {
                            alert("ë„ë¡œëª… ì£¼ì†Œë¡œ ì„ íƒí•´ì£¼ì„¸ìš”! ğŸ›£ï¸");
                            return;
                        }

                        let roadAddr = data.roadAddress;
                        let extraAddr = '';

                        if(data.bname && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)){
                            extraAddr += data.bname;
                        }
                        if(data.buildingName){
                            extraAddr += (extraAddr ? ', ' + data.buildingName : data.buildingName);
                        }

                        let fullAddr = extraAddr ? `${roadAddr} (${extraAddr})` : roadAddr;

                        document.getElementById('postcode').value = data.zonecode;
                        document.getElementById('address').value = fullAddr;
                        document.getElementById('detailAddress').focus();
                    }
                }).open();
            }

            const form = document.querySelector('.form-card');

            form.addEventListener('submit', function(event) {
                const postCode = form.querySelector('input[name="postCode"]').value.trim();
                const address = form.querySelector('input[name="address"]').value.trim();
                const detailAddress = form.querySelector('input[name="detailAddress"]').value.trim();
                const recipientName = form.querySelector('input[name="recipientName"]').value.trim();
                const recipientContact = form.querySelector('input[name="recipientContact"]').value.trim();

                const isDefaultChecked = document.getElementById("isDefaultCheckbox").checked;
                document.getElementById("defaultAddressInput").value = isDefaultChecked ? "true" : "false";

                // ì£¼ì†Œ ê°œìˆ˜ ì œí•œ ê²€ì‚¬
                const mode = form.dataset.mode;
                if (mode === 'new' && typeof addressCount !== 'undefined' && addressCount >= 10) {
                    alert("ì£¼ì†ŒëŠ” ìµœëŒ€ 10ê°œê¹Œì§€ ë“±ë¡í•  ìˆ˜ ìˆì–´ìš”! ğŸ˜…");
                    event.preventDefault();
                    return;
                }

                // í•„ìˆ˜ ì…ë ¥ ê²€ì¦
                if (!postCode || !address || !detailAddress || !recipientName || !recipientContact) {
                    alert("í•„ìˆ˜ ì…ë ¥ë€ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”! ğŸ™");
                    event.preventDefault(); // í¼ ì œì¶œ ë§‰ê¸°
                }
            });
        </script>

        <div class="back-to-list-wrapper">
            <button type="button" class="back-to-list-btn" onclick="location.href='/address-list'">
                ğŸ“‹ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>
    </section>
</main>
</html>
