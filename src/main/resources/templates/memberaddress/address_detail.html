<!DOCTYPE html>
<html layout:decorate="~{layout/layout}"
      th:lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head layout:fragment="head" title="주소상세">
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/page/_address-list.css}" />
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<main layout:fragment="content">
    <section class="main-content" style="position: relative;"
             th:with="actionUrl=${mode == 'edit'} ? '/addresses/save?mode=edit&addressId=' + ${address.memberAddressId} : '/addresses/save?mode=new'">

        <form th:action="@{${actionUrl}}"
              method="post"
              class="form-card"
              th:data-mode="${mode}">

            <h1>📍 배송지 상세</h1>

            <input type="hidden" name="addressId" th:if="${mode == 'edit'}" th:value="${address.memberAddressId}" />

            <label>우편번호</label>
            <input type="text" id="postcode" name="postCode"
                   th:readonly="${!(mode == 'new' or mode == 'edit')}"
                   th:value="${address?.postCode}" />
            <button type="button" id="postcodeBtn" th:if="${mode == 'new' or mode == 'edit'}" onclick="openPostcode()">우편번호 찾기</button>

            <label>주소</label>
            <input type="text" id="address" name="address"
                   th:readonly="${!(mode == 'new' or mode == 'edit')}"
                   th:value="${address?.address}" />

            <label>상세주소</label>
            <input type="text" id="detailAddress" name="detailAddress"
                   th:readonly="${!(mode == 'new' or mode == 'edit')}"
                   th:value="${address?.detailAddress}"
                   placeholder="상세주소를 입력하세요" />

            <label>주소 별칭</label>
            <input type="text" id="addressName" name="addressName"
                   th:readonly="${!(mode == 'new' or mode == 'edit')}"
                   th:value="${address?.addressName}"
                   placeholder="예: 집, 회사" />

            <label>받는 사람</label>
            <input type="text" id="recipientName" name="recipientName"
                   th:readonly="${!(mode == 'new' or mode == 'edit')}"
                   th:value="${address?.recipientName}"
                   placeholder="받는 분 성함을 입력해주세요" />

            <label>연락처</label>
            <input type="tel" id="recipientContact" name="recipientContact"
                   th:readonly="${!(mode == 'new' or mode == 'edit')}"
                   th:value="${address?.recipientContact}"
                   placeholder="010-0000-0000" />

            <label class="checkbox-label" th:if="${mode == 'new' or mode == 'edit'}">
                <input type="checkbox" id="isDefaultCheckbox"
                       th:checked="${address?.defaultAddress}" />
                <!-- 실제 전송될 값 -->
                <input type="hidden" name="defaultAddress" id="defaultAddressInput" value="false" />
                기본 배송지로 설정
            </label>

            <div th:if="${mode == 'new' or mode == 'edit'}">
                <button type="submit" id="saveBtn">저장</button>
            </div>

            <div th:if="${mode == 'view'}" style="margin-top: 30px; text-align:center;">
                <button type="button"
                        th:onclick="|location.href='/addresses/edit/' + ${address.memberAddressId}|">
                    수정하기 ✏️
                </button>
            </div>
        </form>

        <!-- 주소 개수 자바스크립트로 내려주기 -->
        <script th:inline="javascript">
            let addressCount = /*[[${addressCount}]]*/ 0;
        </script>

        <script>
            // 다음 우편번호 api
            function openPostcode() {
                new daum.Postcode({
                    oncomplete: function(data) {
                        // 도로명 주소만 허용
                        if (data.userSelectedType !== 'R') {
                            alert("도로명 주소로 선택해주세요! 🛣️");
                            return;
                        }

                        let roadAddr = data.roadAddress;
                        let extraAddr = '';

                        if(data.bname && /[동|로|가]$/g.test(data.bname)){
                            extraAddr += data.bname;
                        }
                        if(data.buildingName){
                            extraAddr += (extraAddr ? ', ' + data.buildingName : data.buildingName);
                        }

                        let fullAddr = extraAddr ? `${roadAddr} (${extraAddr})` : roadAddr;

                        document.getElementById('postcode').value = data.zonecode;
                        document.getElementById('address').value = fullAddr;
                        document.getElementById('detailAddress').focus();
                    }
                }).open();
            }

            const form = document.querySelector('.form-card');

            form.addEventListener('submit', function(event) {
                const postCode = form.querySelector('input[name="postCode"]').value.trim();
                const address = form.querySelector('input[name="address"]').value.trim();
                const detailAddress = form.querySelector('input[name="detailAddress"]').value.trim();
                const recipientName = form.querySelector('input[name="recipientName"]').value.trim();
                const recipientContact = form.querySelector('input[name="recipientContact"]').value.trim();

                const isDefaultChecked = document.getElementById("isDefaultCheckbox").checked;
                document.getElementById("defaultAddressInput").value = isDefaultChecked ? "true" : "false";

                // 주소 개수 제한 검사
                const mode = form.dataset.mode;
                if (mode === 'new' && typeof addressCount !== 'undefined' && addressCount >= 10) {
                    alert("주소는 최대 10개까지 등록할 수 있어요! 😅");
                    event.preventDefault();
                    return;
                }

                // 필수 입력 검증
                if (!postCode || !address || !detailAddress || !recipientName || !recipientContact) {
                    alert("필수 입력란을 모두 채워주세요! 🙏");
                    event.preventDefault(); // 폼 제출 막기
                }
            });
        </script>

        <div class="back-to-list-wrapper">
            <button type="button" class="back-to-list-btn" onclick="location.href='/address-list'">
                📋 목록으로 돌아가기
            </button>
        </div>
    </section>
</main>
</html>
