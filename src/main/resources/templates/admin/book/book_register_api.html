<!DOCTYPE html>
<html layout:decorate="~{layout/layout}"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head layout:fragment="head">
  <meta charset="UTF-8" />
  <title>도서 등록</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/main.css}" />
  <style>
    .book-card { cursor: pointer; }
    .book-card:hover { background-color: #f8f9fa; }
    img { max-width: 100%; height: auto; }
  </style>
</head>

<body>
<main layout:fragment="content">
  <section class="container mt-4">
    <h2>도서 등록</h2>

    <form th:action="@{/admin/book/register}" method="post" enctype="multipart/form-data">
      <div class="mb-3">
        <label for="title" class="form-label">제목</label>
        <input type="text" class="form-control" id="title" name="title" th:value="${book.title}" required />
      </div>

      <div class="mb-3">
        <label for="author" class="form-label">저자</label>
        <input type="text" class="form-control" id="author" name="author" th:value="${book.author}" required />
      </div>

      <div class="mb-3">
        <label for="publisher" class="form-label">출판사</label>
        <input type="text" class="form-control" id="publisher" name="publisher" th:value="${book.publisher}" required />
      </div>

      <div class="mb-3">
        <label for="pubDate" class="form-label">출판일</label>
        <input type="date" class="form-control" id="pubDate" name="pubDate"
               th:value="${book.pubDate}" required />
      </div>

      <div class="mb-3">
        <label for="isbn" class="form-label">ISBN</label>
        <input type="text" class="form-control" id="isbn" name="isbn" th:value="${book.isbn}" required />
      </div>

      <div class="mb-3">
        <label for="regularPrice" class="form-label">정가</label>
        <input type="number" class="form-control" id="regularPrice" name="regularPrice"
               th:value="${book.priceStandard}" required />
      </div>

      <div class="mb-3">
        <label for="salePrice" class="form-label">판매가</label>
        <input type="number" class="form-control" id="salePrice" name="salePrice"
               th:value="${book.priceSales}" required />
      </div>

      <div class="mb-3">
        <label for="description" class="form-label">책 소개</label>
        <textarea class="form-control" id="description" name="description" rows="4"
                  th:text="${book.description}"></textarea>
      </div>

      <div class="mb-3">
        <label for="contents" class="form-label">목차</label>
        <textarea class="form-control" id="contents" name="contents" rows="6"></textarea>
      </div>

      <div class="mb-3">
        <label for="count" class="form-label">재고 수량</label>
        <input type="number" class="form-control" id="count" name="count" value="1" min="0" required />
      </div>

      <div class="mb-3">
        <select id="level1" onchange="onChangeLevel1()">
          <option value="">1차 카테고리 선택</option>
        </select>

        <select id="level2" onchange="onChangeLevel2()">
          <option value="">2차 카테고리 선택</option>
        </select>

        <select id="level3">
          <option value="">3차 카테고리 선택</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">도서 표지</label><br />
        <img th:src="${book.cover}" alt="책 표지" style="max-width: 150px; border-radius: 8px;" />
        <input type="hidden" name="imageFileUrl" th:value="${book.cover}" />
      </div>

      <button type="submit" class="btn btn-primary">등록</button>
    </form>
  </section>
  <th:block layout:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/book/registerBook.js}"> </script>
    <script>
      let categoryTree = [];

      fetch('/categories/tree')
              .then(res => res.json())
              .then(data => {
                categoryTree = data;
                const level1 = document.getElementById('level1');
                data.forEach(cat => {
                  const option = document.createElement('option');
                  option.value = cat.id;
                  option.textContent = cat.categoryName;
                  level1.appendChild(option);
                });
              });

      function onChangeLevel1() {
        const level1Id = document.getElementById('level1').value;
        const level2 = document.getElementById('level2');
        const level3 = document.getElementById('level3');
        level2.innerHTML = '<option value="">2차 카테고리 선택</option>';
        level3.innerHTML = '<option value="">3차 카테고리 선택</option>';

        const selected = categoryTree.find(cat => cat.id == level1Id);
        if (selected) {
          selected.children.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.categoryName;
            level2.appendChild(option);
          });
        }
      }

      function onChangeLevel2() {
        const level1Id = document.getElementById('level1').value;
        const level2Id = document.getElementById('level2').value;
        const level3 = document.getElementById('level3');
        level3.innerHTML = '<option value="">3차 카테고리 선택</option>';

        const selected1 = categoryTree.find(cat => cat.id == level1Id);
        const selected2 = selected1?.children.find(cat => cat.id == level2Id);
        if (selected2) {
          selected2.children.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = cat.categoryName;
            level3.appendChild(option);
          });
        }
      }
    </script>
  </th:block>
</main>
</body>
</html>